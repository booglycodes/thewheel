<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wheel</title>
    <style>
        h1 {
            padding-left: 20px;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            touch-action: manipulation;
        }

        textarea {
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            resize: none;
            width: max-content;
            margin-left: 10px;
            margin-top: 10px;
        }

        button {
            background-color: #d3d3d3;
            color: #000000;
            border: 1px solid #000000;
            padding: 10px 15px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #f1f1f1;
        }

        .selected-button {
            background-color: #5f8094;
        }

        @media (max-width: 400px) {
            .lower-button {
                margin-right: 100px;
            }
        }

        select {
            background-color: #e0e0e0;
            color: #333;
            padding: 8px 12px;
            border: 1px solid #000000;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            position: relative;
            width: auto;
        }
    </style>
    </style>
</head>

<body>
    <h1>Wheel
        <!-- history -->
        <a onclick="history()">
            <svg fill="#000000" height="30px" width="30px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                    viewBox="0 0 484 484" xml:space="preserve">
                <g>
                    <g>
                        <g>
                            <g>
                                <path d="M410.413,70.88C364.706,25.172,303.934,0,239.293,0c-47.493,0-93.076,13.591-132.383,39.378l-2.909-2.985
                                    C93.086,25.194,77.521,20.808,62.366,24.662c-15.155,3.854-26.735,15.14-30.975,30.192L4.369,150.781
                                    c-4.239,15.05-0.255,30.72,10.658,41.917c8.308,8.524,19.31,13.101,30.775,13.101c3.595,0,7.236-0.45,10.854-1.37l96.591-24.548
                                    c15.156-3.852,26.736-15.137,30.978-30.189c3.54-12.562,1.331-25.547-5.836-36.012C197.287,104.713,218.107,100,239.293,100
                                    c78.299,0,142,63.701,142,142s-63.701,142-142,142c-40.717,0-79.54-17.527-106.514-48.087
                                    c-18.243-20.667-49.903-22.642-70.573-4.399c-10.013,8.838-15.985,21.046-16.816,34.376
                                    c-0.831,13.329,3.579,26.185,12.417,36.198C103.753,454.144,169.903,484,239.293,484c64.641,0,125.414-25.172,171.121-70.88
                                    c45.708-45.708,70.88-106.479,70.88-171.12S456.121,116.588,410.413,70.88z M164.975,144.269
                                    c-2.28,8.092-8.506,14.159-16.654,16.23L51.73,185.046c-8.146,2.072-16.513-0.287-22.38-6.307
                                    c-5.867-6.02-8.009-14.444-5.73-22.536l27.023-95.928c2.279-8.092,8.504-14.16,16.652-16.231
                                    c8.15-2.071,16.516,0.286,22.383,6.307l33.072,33.933l32.604,33.454c0.003,0.003,0.006,0.005,0.009,0.008l3.883,3.984
                                    C165.113,127.751,167.255,136.177,164.975,144.269z M396.271,398.978C354.341,440.908,298.592,464,239.293,464
                                    c-63.656,0-124.34-27.39-166.492-75.147c-5.303-6.008-7.948-13.722-7.45-21.719s4.082-15.323,10.089-20.625
                                    c5.695-5.026,12.777-7.494,19.835-7.494c8.313,0,16.589,3.427,22.51,10.133C148.553,384.007,192.841,404,239.293,404
                                    c89.328,0,162-72.673,162-162s-72.673-162-162-162c-26.21,0-51.956,6.312-74.942,18.314l-11.509-11.809l-31.691-32.517
                                    C156.439,31.715,197.037,20,239.293,20c59.299,0,115.048,23.092,156.978,65.022c41.931,41.93,65.022,97.679,65.022,156.978
                                    S438.201,357.047,396.271,398.978z"/>
                            </g>
                        </g>
                        <g>
                            <path d="M420.202,336.007c-1.397,0-2.817-0.294-4.17-0.916c-5.019-2.306-7.217-8.244-4.911-13.262
                                c11.395-24.793,17.172-51.315,17.172-78.829c0-35.76-10.031-70.57-29.01-100.666c-2.945-4.672-1.547-10.847,3.125-13.792
                                c4.672-2.948,10.846-1.547,13.793,3.125c20.994,33.294,32.092,71.793,32.092,111.334c0,30.417-6.392,59.749-18.999,87.18
                                C427.611,333.846,423.987,336.007,420.202,336.007z"/>
                        </g>
                        <g>
                            <path d="M375.291,107.724c-2.45,0-4.904-0.895-6.834-2.701c-13.866-12.987-29.525-23.772-46.542-32.057
                                c-4.966-2.418-7.031-8.403-4.614-13.369c2.417-4.965,8.403-7.031,13.368-4.614c18.817,9.162,36.131,21.086,51.46,35.442
                                c4.031,3.775,4.238,10.104,0.463,14.135C380.623,106.662,377.96,107.724,375.291,107.724z"/>
                        </g>
                    </g>
                    <g>
                        <path d="M284.002,329c-8.014,0-15.548-3.121-21.214-8.787l-44.499-44.5c-5.675-5.675-8.784-13.202-8.776-21.228
                            c-0.007-0.161-0.011-0.322-0.011-0.485V151c0-16.542,13.458-30,30-30s30,13.458,30,30v91.073l35.714,35.713v0
                            c11.695,11.697,11.695,30.729,0,42.426C299.55,325.879,292.016,329,284.002,329z M229.502,253.729
                            c0.006,0.132,0.01,0.263,0.012,0.396c0.001,0.083,0,0.165,0,0.248c-0.035,2.726,1.001,5.283,2.918,7.199l44.499,44.5
                            c1.889,1.889,4.4,2.929,7.071,2.929s5.183-1.04,7.071-2.929c3.898-3.898,3.898-10.243,0-14.142l-38.643-38.642
                            c-1.875-1.875-2.929-4.419-2.929-7.071V151c0-5.514-4.486-10-10-10c-5.514,0-10,4.486-10,10V253.729z"/>
                    </g>
                </g>
            </svg>
        </a>

        <!-- settings -->
        <a onclick="edit_wheels()">
            <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 3H13C13.5523 3 14 3.44772 14 4V4.56879C14 4.99659 14.2871 5.36825 14.6822 5.53228C15.0775 5.69638 15.5377 5.63384 15.8403 5.33123L16.2426 4.92891C16.6331 4.53838 17.2663 4.53838 17.6568 4.92891L19.071 6.34312C19.4616 6.73365 19.4615 7.36681 19.071 7.75734L18.6688 8.1596C18.3661 8.46223 18.3036 8.92247 18.4677 9.31774C18.6317 9.71287 19.0034 10 19.4313 10L20 10C20.5523 10 21 10.4477 21 11V13C21 13.5523 20.5523 14 20 14H19.4312C19.0034 14 18.6318 14.2871 18.4677 14.6822C18.3036 15.0775 18.3661 15.5377 18.6688 15.8403L19.071 16.2426C19.4616 16.6331 19.4616 17.2663 19.071 17.6568L17.6568 19.071C17.2663 19.4616 16.6331 19.4616 16.2426 19.071L15.8403 18.6688C15.5377 18.3661 15.0775 18.3036 14.6822 18.4677C14.2871 18.6318 14 19.0034 14 19.4312V20C14 20.5523 13.5523 21 13 21H11C10.4477 21 10 20.5523 10 20V19.4313C10 19.0034 9.71287 18.6317 9.31774 18.4677C8.92247 18.3036 8.46223 18.3661 8.1596 18.6688L7.75732 19.071C7.36679 19.4616 6.73363 19.4616 6.34311 19.071L4.92889 17.6568C4.53837 17.2663 4.53837 16.6331 4.92889 16.2426L5.33123 15.8403C5.63384 15.5377 5.69638 15.0775 5.53228 14.6822C5.36825 14.2871 4.99659 14 4.56879 14H4C3.44772 14 3 13.5523 3 13V11C3 10.4477 3.44772 10 4 10L4.56877 10C4.99658 10 5.36825 9.71288 5.53229 9.31776C5.6964 8.9225 5.63386 8.46229 5.33123 8.15966L4.92891 7.75734C4.53838 7.36681 4.53838 6.73365 4.92891 6.34313L6.34312 4.92891C6.73365 4.53839 7.36681 4.53839 7.75734 4.92891L8.15966 5.33123C8.46228 5.63386 8.9225 5.6964 9.31776 5.53229C9.71288 5.36825 10 4.99658 10 4.56876V4C10 3.44772 10.4477 3 11 3Z" stroke="#000000" stroke-width="1.5"/>
                <path d="M14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12Z" stroke="#000000" stroke-width="1.5"/>
            </svg>
        </a>

        <!-- sheet -->
        <a href="https://docs.google.com/spreadsheets/d/1ray4gflepLQH7RRHBEcuRZEIv7GfNlkQmqLbiCvCanA">
            <svg fill="#000000" height="30px" width="30px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                viewBox="0 0 512.001 512.001" xml:space="preserve">
            <g>
                <g>
                    <path d="M463.996,126.864L340.192,3.061C338.232,1.101,335.574,0,332.803,0H95.726C67.725,0,44.944,22.782,44.944,50.784v410.434
                        c0,28.001,22.781,50.783,50.783,50.783h320.547c28.001,0,50.783-22.781,50.783-50.783V134.253
                        C467.056,131.482,465.955,128.824,463.996,126.864z M343.254,35.678h0.001l88.126,88.126h-58.242
                        c-7.984,0-15.49-3.109-21.134-8.753c-5.643-5.643-8.752-13.148-8.751-21.131V35.678z M446.159,461.217
                        c-0.001,16.479-13.407,29.885-29.885,29.885H95.726c-16.479,0-29.885-13.406-29.885-29.885V50.784
                        c0.001-16.479,13.407-29.886,29.885-29.886h226.631v73.021c-0.002,13.565,5.28,26.318,14.872,35.909
                        c9.591,9.592,22.345,14.874,35.911,14.874h73.019V461.217z"/>
                </g>
            </g>
            <g>
                <g>
                    <path d="M376.882,209.049H135.119c-5.771,0-10.449,4.678-10.449,10.449V361.94c0,5.771,4.678,10.449,10.449,10.449h241.763
                        c5.771,0,10.449-4.678,10.449-10.449V219.498C387.331,213.728,382.652,209.049,376.882,209.049z M245.551,351.492h-99.984V324.92
                        h0.001h99.983V351.492z M245.551,304.022h-99.984v-26.606h0.001h99.983V304.022z M245.551,256.518h-99.984v-26.572h99.984V256.518
                        z M366.433,351.492h-99.984V324.92h99.984V351.492z M366.433,304.022h-99.984v-26.606h99.984V304.022z M366.433,256.518h-99.984
                        v-26.572h99.984V256.518z"/>
                </g>
            </g>
            <g>
                <g>
                    <path d="M139.796,392.86h-4.678c-5.771,0-10.449,4.678-10.449,10.449c0,5.771,4.678,10.449,10.449,10.449h4.678
                        c5.771,0,10.449-4.678,10.449-10.449C150.245,397.539,145.567,392.86,139.796,392.86z"/>
                </g>
            </g>
            <g>
                <g>
                    <path d="M275.091,392.86H173.599c-5.771,0-10.449,4.678-10.449,10.449c0,5.771,4.678,10.449,10.449,10.449h101.492
                        c5.771,0,10.449-4.678,10.449-10.449C285.54,397.539,280.862,392.86,275.091,392.86z"/>
                </g>
            </g>
            </svg>
        </a>
    </h1>
    <script>
        const OAUTH_URL = 'https://www.googleapis.com/oauth2/v4/token'
        const GOOGLE_SHEETS_SCOPE = 'https://www.googleapis.com/auth/spreadsheets'
        const GOOGLE_SHEETS_URL = 'https://sheets.googleapis.com/v4/spreadsheets/{0}/values/Sheet1!{1}?{2}'
        const WHEEL_SHEETS_ID = '1ray4gflepLQH7RRHBEcuRZEIv7GfNlkQmqLbiCvCanA'
        const SERVICE_ACCOUNT = {
            'type': 'service_account',
            'project_id': 'wheel-431014',
            'private_key_id': '338665c2d750' + 'e1c4fe' +
                '9d8475e2af962b593c7744',
            'private_key': '-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAg' +
                'EAAoIBAQCkTta0oWaWwtY+\nHTQEpvs5JJILd/rqR6w6+ByK6F2E/rjOPv3fv5Lr+hM1ThMNv/iIkK2BQWjXI5ut\n' +
                'RtoL0X2zCnkaC4z3hgRN86fnbNzCLx0Y94k6S3ykMzVCQhdCWC3mqq8zc9rH7/4v\nETkMkvvAQ72cc8+hXnvW19cD8feIvGLLtarmRME52NJlFKQHpYKjnRuKU2oowxSQ\nAVXC3z6etmWbGdxXAJbYZ9bxKa22P7kavd5tNvxJxQf1U6VjksWheHXrx+d2Cg5J\nl7p5Q8i2VSqg3wdtKNcVe/EwBGT1gCSLN6kOgnQ1mZP+I75KoCThfDn2uaYwRYHT\nqcSOE/SdAgMBAAECggEACAcOVfPn6ky76jLWD7Yghw5CkK+YCoWCW09888uVPGa0\nHObx9/bJFOpDjLKqCO+6XAbgZGJ9XrvGbABX0nK11tYFXs5RhXj1Y+FPAtPnsz1Z\nUmAGQv+mJ/NLrcT53Tlw94ZRvpWV+JxTLho60BmHuoo93xya09a3RuvztADbDIri\n+E0A8JaWAN3tuuio/dNm0UPAltBJSF7nTxoQTSUi6ne/34qIIrQc6dN5onjerRDU\nmuLpq9q5DzsXTD8fD78vnuDtX3x2e6w2r9bL4Zm0sBj5ICAh/hkC1R/FJh6ahvEn\n+LgNg4SDt0uCqk/A6S2bo1cgdLePoPSMUmRQqo4SBwKBgQDkqg5Umbx0aaNY/bg5\nC0no0+5TpTgjoDlhcvP9aqqjcMCvKzWKjmIsvSwITTGi7kzWXIjwjGyeKwyW0sLs\nz4KNsyvYJZwg5u4WRvXKFRlg5RypFGTyx6vIF9h0knse4ls0iNQVSTJD8gq5jXQc\n/IC78iLyD2p6nrhMVAVaIlcevwKBgQC38z/cN3Oelb8nqQntUd0IB1c73wdcHQ5s\nJPdTfC1n15ZTYdEH/3UR7hwXoRoJ0LtFcvKlAOTWrftqmncZsjPY/RYnm0XZG8Hf\n04xJ6sB5kiSb2FGvIohpXZEfKRhC8/ilOuhBe7iWQIBysDnGVvkWc5//VkChnEMu\nFE08Ku3fowKBgQCRUSVUTHNAhBXkKzHVRsBMr8qo67nWoi91J6m5Zf1VawV5DPu0\ntzHa/smp6Ozff5PjMuFwBb3NcsxIWV65QlLUnIYDkjs7iabLD4OKTohXVKM3LJfO\n1mfr/IN56dFG2lFd/IrTkDXaikqYizW8aheh2YqtzHA9xvqWv1q7YlF9XwKBgGry\ns0M+visKlzvgzNO8z8x2MCKwFeBZSGRZza4tOVzxfAX4jgafYJpPHOgkEzZ3tBm5\nrhd/AI1MVCtzqSE4eWqEItheL2r992dB4IOtR8Cm1kABseQoKLVR4CkExIVQwVSX\nfidsXjKFR+jmSoDlWibSjMhwhl0vs+NbjFgaAXkPAoGARpieI8L/C49oO5PdKYlo\nsty9kg1+jxnsy46ToabmTxwaVh5iI6JJY2ePtCAr9VY8EWuQyl75dSYsGuHsztAE\nELUUP3i8g8DHyD063B7HzWvt5KXajeDGu95NEScZ6R6jATLNcDuNnY2llWq9lxB5\nW5H1ANiuKjCQrzgS8IS7Wns=\n-----END PRIVATE KEY-----\n',
            'client_email': 'wheelacc@wheel-431014.iam.gserviceaccount.com',
            'client_id': '114172704513' + '412960649',
            'auth_uri': 'https://accounts.google.com/o/oauth2/auth',
            'token_uri': 'https://oauth2.googleapis.com/token',
            'auth_provider_x509_cert_url': 'https://www.googleapis.com/oauth2/v1/certs',
            'client_x509_cert_url': 'https://www.googleapis.com/robot/v1/metadata/x509/wheelacc%40wheel-431014.iam.gserviceaccount.com',
            'universe_domain': 'googleapis.com'
        }

        if (!String.prototype.format) {
            String.prototype.format = function () {
                var args = arguments
                return this.replace(/{(\d+)}/g, function (match, number) {
                    return typeof args[number] != 'undefined'
                        ? args[number]
                        : match
                })
            }
        }

        let wheel_history = []
        let wheel_history_descriptions = ['']
        let spin_counter = {}
        let current_spin = ''
        let authToken
        let state
        let filter_state = ''
        let random_dropdown_state = 'random-number'

        let wheels
        let wheel_metadata
        let wheel_names
        async function start() {
            created_wheel_dropdown_callback_for_spin = false
            created_wheel_dropdown_callback_for_remove = false
            authToken = await fetchAuthToken()
            let [w, w_metadata, w_names] = await getWheels(authToken)
            wheels = w
            wheel_metadata = w_metadata
            wheel_names = w_names

            let btns = []
            state = 'spin'
            for (let btn of [['add', add], ['spin', spins], ['remove', remove], ['random', rand]]) {
                let button = document.createElement('button')
                button.id = btn[0]
                button.textContent = btn[0]
                button.style.marginLeft = '10px'
                button.style.fontSize = '16px'
                button.style.cursor = 'pointer'
                button.className = 'button'
                document.body.appendChild(button)
                btns.push(button)
                button.addEventListener('click', function () {
                    for (let btn of btns) {
                        btn.className = 'button'
                        btn.style.boxShadow = 'none'
                        btn.style.marginLeft = '10px'
                    }
                    this.className = 'selected-button'
                    this.style.marginLeft = '10px'

                    this.style.boxShadow = '0 0 0 5px rgba(1.0, 0, 0, 0.3)'
                    cleanslate()
                    btn[1](authToken)
                    state = btn[0]
                })
            }
            btns[1].className = 'selected-button'
            btns[1].style.boxShadow = '0 0 0 5px rgba(1.0, 0, 0, 0.3)'
            let wheel_dropdown_container = document.createElement('div')
            let wheel_dropdown = document.createElement('select')
            wheel_dropdown.style.marginTop = '15px'
            wheel_dropdown.style.marginLeft = '10px'
            wheel_dropdown.style.fontSize = '16px'
            wheel_dropdown.id = 'wheel-dropdown'
            for (let wheel_name of wheel_names) {
                if (wheel_metadata[wheel_name].tags.includes('deleted')) {
                    continue
                }
                let option = document.createElement('option')
                option.value = wheel_name
                option.innerText = wheel_name
                wheel_dropdown.appendChild(option)
            }
            wheel_dropdown.value = 'bigly'
            wheel_dropdown_container.id = 'wheel-dropdown-container'
            wheel_dropdown_container.appendChild(wheel_dropdown)
            document.body.appendChild(wheel_dropdown_container)
            spins()
        }

        function history() {
            cleanslate()
            if (document.getElementById('add') != null) {
                document.body.removeChild(document.getElementById('add'))
                document.body.removeChild(document.getElementById('spin'))
                document.body.removeChild(document.getElementById('remove'))
                document.body.removeChild(document.getElementById('random'))
                document.body.removeChild(document.getElementById('wheel-dropdown-container'))
            }
            let button = document.createElement('button')
            button.textContent = 'back'
            button.style.marginLeft = '10px'
            button.style.fontSize = '16px'
            button.style.cursor = 'pointer'
            button.className = 'button'
            button.addEventListener('click', function () {
                start()
            })
            let container = document.createElement('div')
            for (let i = 0; i < wheel_history_descriptions.length; i++) {
                let entry = document.createElement('div')
                let dark = i % 2 === 0
                if (dark) {
                    entry.style.background = 'darkgrey'
                } else {
                    entry.style.background = 'lightgrey'
                }
                entry.style.maxWidth = '1200px'
                entry.style.verticalAlign = 'middle'
                entry.style.alignItems = 'center'
                entry.style.display = 'flex'
                entry.style.height = 'auto'
                container.appendChild(entry)

                let task = document.createElement('div')
                task.textContent = 'version ' + i + ' ' + wheel_history_descriptions[i]
                task.style.fontSize = '16px'
                task.style.marginRight = '30px'
                task.style.display = 'inline-block'
                task.style.width = 'auto'
                task.style.wordWrap = 'break-word'
                task.style.whiteSpace = 'normal'
                task.style.marginBottom = '10px'
                task.style.marginTop = '10px'
                task.style.marginLeft = '5px'
                task.style.cursor = 'default'
                task.className = 'noselect'
                entry.appendChild(task)
                entry.addEventListener('click', function () {
                    revert(i)
                    document.body.removeChild(container)
                    start()
                })
            }
            document.body.appendChild(container)
        }

        function revert(version) {
            if (version === wheel_history.length) {
                alert('selected current version, not reverting')
                return
            }
            if (version === wheel_history_descriptions.length - 1) {
                alert('selected current version, not reverting')
                return
            }
            let [w, w_metadata, w_names] = wheel_history[version]
            wheels = w
            wheel_metadata = w_metadata
            wheel_names = w_names
            wheel_history.length = version + 1
            wheel_history_descriptions.length = version + 1

            writeSheet(wheels_to_data(wheels, wheel_metadata, wheel_names), authToken)
            alert('revert successful')
        }

        function edit_wheels() {
            cleanslate()
            if (document.getElementById('add') != null) {
                document.body.removeChild(document.getElementById('add'))
                document.body.removeChild(document.getElementById('spin'))
                document.body.removeChild(document.getElementById('remove'))
                document.body.removeChild(document.getElementById('random'))
                document.body.removeChild(document.getElementById('wheel-dropdown-container'))
            }

            let all = document.createElement('div')
            let new_cont = document.createElement('div')
            new_cont.style.margin = '5px'
            new_cont.textContent = 'add a new wheel'
            let new_wheel = document.createElement('input')
            new_wheel.style.margin = '5px'
            new_cont.appendChild(new_wheel)
            all.appendChild(new_cont)
            new_wheel.addEventListener('keydown', function(e) {
                if(e.key != 'Enter') {
                    return
                }
                wheel_history.push([
                    JSON.parse(JSON.stringify(wheels)), 
                    JSON.parse(JSON.stringify(wheel_metadata)), 
                    JSON.parse(JSON.stringify(wheel_names))
                ])
                wheel_history_descriptions.push('add new wheel ' + new_wheel.value)
                wheel_metadata[new_wheel.value] = {count : 0, tags : []}
                wheels[new_wheel.value] = []
                wheel_names.push(new_wheel.value)
                writeSheet(wheels_to_data(wheels, wheel_metadata, wheel_names), authToken)
                document.body.removeChild(all)
                start()
            })


            for (let i = 0; i < wheel_names.length; i++) {
                let container = document.createElement('div')
                container.style.margin = '5px'
                container.textContent = wheel_names[i]
                let tags = document.createElement('input')
                tags.style.margin = '5px'
                container.appendChild(tags)
                all.appendChild(container)
                tags.addEventListener('keydown', function(e) {
                    if(e.key != 'Enter') {
                        return
                    }
                    wheel_history.push([
                        JSON.parse(JSON.stringify(wheels)), 
                        JSON.parse(JSON.stringify(wheel_metadata)), 
                        JSON.parse(JSON.stringify(wheel_names))
                    ])
                    wheel_history_descriptions.push('update ' + wheel_names[i] + ' wheel tags to ' + tags.value)
                    wheel_metadata[wheel_names[i]].tags = tags.value.split(/\s+/)
                    writeSheet(wheels_to_data(wheels, wheel_metadata, wheel_names), authToken)
                    document.body.removeChild(all)
                    start()
                })
            }


            

            document.body.appendChild(all)
        }

        function cleanslate() {
            document.getElementById('wheel-dropdown').style.display = ''
            if (all_option != null) {
                if (document.getElementById('wheel-dropdown').value === 'all') {
                    document.getElementById('wheel-dropdown').value = prev_wheel_before_all
                    prev_wheel_before_all = null
                }
                document.getElementById('wheel-dropdown').removeChild(all_option)
                all_option = null
            }
            document.getElementById('container').remove()
        }

        const JwtSigner = (function () {
            // Helper: Convert PEM to ArrayBuffer
            function pemToArrayBuffer(pem) {
                const b64 = pem.replace(/-----.*?-----/g, "").replace(/\s+/g, "");
                const binary = atob(b64);
                const buffer = new ArrayBuffer(binary.length);
                const view = new Uint8Array(buffer);
                for (let i = 0; i < binary.length; i++) {
                    view[i] = binary.charCodeAt(i);
                }
                return buffer;
            }

            // Helper: Base64url encode a string
            function base64UrlEncode(input) {
                return btoa(input)
                    .replace(/=/g, '')
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_');
            }

            // Helper: Create the header and payload parts of a JWT
            function createJwtParts(header, payload) {
                const encodedHeader = base64UrlEncode(JSON.stringify(header));
                const encodedPayload = base64UrlEncode(JSON.stringify(payload));
                return `${encodedHeader}.${encodedPayload}`;
            }

            // Main function: Sign a JWT
            async function sign(privateKeyPem, payload) {
                // Define the header
                const header = { alg: "RS256", typ: "JWT" };

                // Create the unsigned JWT parts
                const dataToSign = createJwtParts(header, payload);

                // Import the private key
                const privateKey = await window.crypto.subtle.importKey(
                    "pkcs8",
                    pemToArrayBuffer(privateKeyPem),
                    { name: "RSASSA-PKCS1-v1_5", hash: "SHA-256" },
                    false,
                    ["sign"]
                );

                // Sign the JWT parts
                const signature = await window.crypto.subtle.sign(
                    "RSASSA-PKCS1-v1_5",
                    privateKey,
                    new TextEncoder().encode(dataToSign)
                );

                // Convert signature to base64url format
                const encodedSignature = base64UrlEncode(String.fromCharCode(...new Uint8Array(signature)));

                // Return the full signed JWT
                return `${dataToSign}.${encodedSignature}`;
            }

            // Expose the `sign` function
            return { sign };
        })();

        // see https://stackoverflow.com/questions/28751995/how-to-obtain-google-service-account-access-token-javascript
        async function fetchAuthToken() {
            let claim = {
                aud: OAUTH_URL,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                iss: SERVICE_ACCOUNT.client_email,
                exp: Math.floor(Date.now() / 1000) + 3600,
                iat: Date.now() / 1000
            }
            let jws = await JwtSigner.sign(SERVICE_ACCOUNT.private_key, claim)

            let response = await fetch(OAUTH_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: jws
                })
            })
            let responseData = await response.json()
            return responseData.access_token
        }

        async function readSheet(range, authToken, queryParams) {
            let response = await fetch(GOOGLE_SHEETS_URL.format(WHEEL_SHEETS_ID, range, queryParams), {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                }
            })
            return await response.json()
        }

        async function writeSheet(data, authToken) {
            let response = await fetch(GOOGLE_SHEETS_URL.format(WHEEL_SHEETS_ID, 'A1', 'valueInputOption=RAW'), {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + authToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    range: 'Sheet1!A1',
                    majorDimension: 'COLUMNS',
                    values: data
                })
            })
            return await response.json()
        }

        async function getWheels(authToken) {
            // this assumes we have < 26 wheels and no wheel contains more than 1000 items
            let data = await readSheet('A1:Z1000', authToken, 'majorDimension=COLUMNS')
            let wheels = {}
            let wheel_metadata = {}
            let wheel_names = []
            for (let wheel of data.values) {
                let wheel_name = wheel.shift()
                wheel_names.push(wheel_name)
                wheels[wheel_name] = []
                let metadata = wheel.shift()
                let count = parseInt(metadata)

                if (Number.isNaN(count)) {
                    wheel_metadata[wheel_name] = JSON.parse(metadata)
                    count = wheel_metadata[wheel_name].count
                } else {
                    wheel_metadata[wheel_name] = {'count' : count, 'tags' : []}
                }
                for (let i = 0; i < count; i++) {
                    let item = wheel.shift()
                    if (isJson(item)) {
                        wheels[wheel_name].push(JSON.parse(item))
                    } else {
                        wheels[wheel_name].push(item)
                    }
                }
            }
            return [wheels, wheel_metadata, wheel_names]
        }

        function isJson(str) {
            try {
                let value = JSON.parse(str)
                return typeof value === 'object' && value !== null
            } catch (e) {
                return false
            }
        }

        let created_wheel_dropdown_callback_for_spin = false
        let numSpins = null
        function spins() {
            let container = document.createElement('div')
            container.id = 'container'
            document.body.appendChild(container)

            numSpins = document.createElement('div')
            numSpins.style.marginTop = '10px'
            numSpins.style.marginLeft = '10px'
            numSpins.style.marginBottom = '10px'

            for (let wheel_name of wheel_names) {
                if (spin_counter[wheel_name] === undefined) {
                    spin_counter[wheel_name] = 0
                }
            }

            let button = document.createElement('button')
            button.id = 'spin';
            button.textContent = 'jamble!'
            button.style.marginLeft = '10px'
            button.style.marginTop = '10px'
            button.style.marginBottom = '0px'
            button.style.fontSize = '12px'
            button.style.cursor = 'pointer'
            button.className = 'button lower-button'
            container.appendChild(button)
            button.addEventListener('click', function () {
                let wheel = document.getElementById('wheel-dropdown').value
                if (wheels[wheel].length === 0) {
                    throw new Error('no tasks in this wheel')
                }
                let spin = wheels[wheel][get_random_spin(wheels[wheel])]
                if (typeof spin === 'string') {
                    current_spin = spin
                } else {
                    if (spin['message'] !== undefined) {
                        current_spin = spin['message']
                    } else {
                        current_spin = JSON.stringify(spin)
                    }
                }
                output.innerText = current_spin
                spin_counter[wheel] += 1
                numSpins.textContent = 'Spins: ' + spin_counter[wheel]
            })

            if (!created_wheel_dropdown_callback_for_spin) {
                document.getElementById('wheel-dropdown').addEventListener('change', () => {
                    if (state === 'spin') {
                        let wheel = document.getElementById('wheel-dropdown').value
                        numSpins.textContent = 'Spins: ' + spin_counter[wheel]
                    }
                })
                created_wheel_dropdown_callback_for_spin = true
            }

            let wheel = document.getElementById('wheel-dropdown').value
            numSpins.textContent = 'Spins: ' + spin_counter[wheel]
            container.appendChild(numSpins)

            let output = document.createElement('div')
            output.id = 'output'
            output.style.margin = '10px'
            output.style.fontSize = '1.5em'
            output.innerText = current_spin
            container.appendChild(output)
        }

        function add(authToken) {
            let container = document.createElement('div')
            container.id = 'container'
            document.body.appendChild(container)
            let div = document.createElement('div')
            container.appendChild(div)
            let textbox = document.createElement('textarea')
            textbox.id = 'textbox'
            textbox.type = 'text'
            textbox.placeholder = 'Enter spin here'
            if (window.innerWidth > 1000) {
                textbox.rows = 20
                textbox.cols = 100
            } else {
                textbox.rows = 5
                textbox.cols = 30
            }
            div.appendChild(textbox)

            let weight_or_percentage = document.createElement('input')
            weight_or_percentage.type = 'text';
            weight_or_percentage.placeholder = 'weight or percentage(%)';
            weight_or_percentage.style.marginLeft = '10px'
            weight_or_percentage.style.fontSize = '16px'
            weight_or_percentage.style.marginTop = '15px'
            weight_or_percentage.value = ''
            container.appendChild(weight_or_percentage)

            let button = document.createElement('button')
            button.id = 'add'
            button.textContent = 'add'
            button.style.marginLeft = '10px'
            button.style.marginTop = '10px'
            button.style.marginBottom = '0px'
            button.style.fontSize = '12px'
            button.style.cursor = 'pointer'
            button.className = 'button lower-button'
            container.appendChild(button)
            button.addEventListener('click', function () {
                if (textbox.value == '') {
                    throw Error('task description is empty')
                }

                console.log(wheels)
                wheel_history.push([
                    JSON.parse(JSON.stringify(wheels)), 
                    JSON.parse(JSON.stringify(wheel_metadata)), 
                    JSON.parse(JSON.stringify(wheel_names))
                ])
                let wheel = document.getElementById('wheel-dropdown').value
                if (weight_or_percentage.value === '') {
                    wheels[wheel].push(textbox.value)
                } else {
                    if (weight_or_percentage.value.endsWith('%')) {
                        let percentage = parseFloat(weight_or_percentage.value.substring(0, weight_or_percentage.value.length - 1))
                        if (percentage === NaN) {
                            throw new Error('invalid percentage: not a number')
                        }
                        if (percentage <= 0) {
                            throw new Error('invalid percentage: must be greater than 0%')
                        }
                        let total_percentage = 0
                        for (let spin of wheels[wheel]) {
                            if (typeof spin === 'string') {
                                continue
                            }
                            if (spin['percentage'] !== undefined) {
                                total_percentage += spin['percentage']
                            }
                        }
                        total_percentage += percentage
                        if (total_percentage >= 100) {
                            throw new Error('invalid percentage: percentages in ' + wheel + ' wheel >= 100%')
                        }
                        wheels[wheel].push({ 'message': textbox.value, 'percentage': percentage })
                    } else {
                        let weight = parseFloat(weight_or_percentage.value)
                        if (weight === NaN) {
                            throw new Error('invalid weight: not a number')
                        }
                        if (weight <= 0) {
                            throw new Error('invalid weight: must be greater than 0')
                        }
                        wheels[wheel].push({ 'message': textbox.value, 'weight': parseFloat(weight_or_percentage.value) })
                    }
                }
                wheel_history_descriptions.push("added '" + textbox.value + "' to " + wheel + " wheel") 
                wheel_metadata[wheel].count += 1
                writeSheet(wheels_to_data(wheels, wheel_metadata, wheel_names), authToken)
                textbox.value = ''
                weight_or_percentage.value = ''
            })
        }

        function get_random_spin(wheel) {
            let rand = Math.random()
            let percentage_sum = 0
            let weight_total = 0
            for (let i = 0; i < wheel.length; i++) {
                let spin = wheel[i]
                if (typeof spin === 'string') {
                    weight_total += 1
                } else if (spin['weight'] !== undefined) {
                    weight_total += spin['weight']
                } else if (spin['percentage'] !== undefined) {
                    percentage_sum += spin['percentage'] / 100
                    if (rand < percentage_sum) {
                        return i
                    }
                } else {
                    weight_total += 1
                }
            }
            // normalize rand, discounting percentages, then scale by weight total
            rand = (rand - percentage_sum) / (1 - percentage_sum) * weight_total
            let weight_sum = 0
            for (let i = 0; i < wheel.length; i++) {
                let spin = wheel[i]
                if (typeof spin === 'string') {
                    weight_sum += 1
                } else if (spin['weight'] !== undefined) {
                    weight_sum += spin['weight']
                } else if (spin['percentage'] !== undefined) {
                    continue
                } else {
                    weight_sum += 1
                }
                if (rand < weight_sum) {
                    return i
                }
            }
            return wheel.length - 1
        }

        function wheels_to_data(wheels, wheel_metadata, wheel_names) {
            let data = []
            for (let x = 0; x < wheel_names.length; x++) {
                let col = []
                col.push(wheel_names[x])
                col.push(JSON.stringify(wheel_metadata[wheel_names[x]]))
                for (let y = 0; y < wheels[wheel_names[x]].length; y++) {
                    if (typeof wheels[wheel_names[x]][y] === 'string') {
                        col.push(wheels[wheel_names[x]][y])
                    } else {
                        col.push(JSON.stringify(wheels[wheel_names[x]][y]))
                    }
                }
                data.push(col)
            }
            console.log('data')
            console.log(data)
            return data
        }

        let tasks_to_remove = {}
        let wheels_to_generate_for_remove
        let all_option = null
        let created_wheel_dropdown_callback_for_remove = false
        let remove_container = null
        let prev_wheel_before_all = null
        function remove(authToken) {
            remove_container = document.createElement('div')
            remove_container.id = 'container'
            document.body.appendChild(remove_container)

            let search = document.createElement('input')
            search.type = 'text';
            search.placeholder = 'filter...';
            search.style.marginLeft = '10px'
            search.style.fontSize = '18px'
            search.style.marginTop = '15px'
            search.value = filter_state
            remove_container.appendChild(search)

            all_option = document.createElement('option')
            all_option.value = 'all'
            all_option.innerText = 'all'
            document.getElementById('wheel-dropdown').appendChild(all_option)
            wheels_to_generate_for_remove = [document.getElementById('wheel-dropdown').value]
            prev_wheel_before_all = document.getElementById('wheel-dropdown').value
            search.addEventListener('keyup', function () {
                document.getElementById('spins-container').remove()
                filter_state = search.value
                generate_entries(remove_container, wheels, wheels_to_generate_for_remove, authToken, filter_state)
            })
            if (!created_wheel_dropdown_callback_for_remove) {
                document.getElementById('wheel-dropdown').addEventListener('change', function() {
                    if (state === 'remove') {
                        document.getElementById('spins-container').remove()
                        if (document.getElementById('wheel-dropdown').value === 'all') {
                            wheels_to_generate_for_remove = wheel_names
                        } else {
                            wheels_to_generate_for_remove = [document.getElementById('wheel-dropdown').value]
                            prev_wheel_before_all = document.getElementById('wheel-dropdown').value
                        }
                        generate_entries(remove_container, wheels, wheels_to_generate_for_remove, authToken, filter_state)
                    }
                })
                created_wheel_dropdown_callback_for_remove = true
            }

            generate_entries(remove_container, wheels, wheels_to_generate_for_remove, authToken, filter_state)
        }

        function escapeFilter(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        }

        function escapeReplacement(string) {
            return string.replace(/\$/g, '$$$$')
        }

        function generate_entries(container, wheels, names_of_wheels_to_generate, authToken, filter) {
            let spins = document.createElement('div')
            spins.id = 'spins-container'
            container.appendChild(spins)
            for (let i = 0; i < names_of_wheels_to_generate.length; i++) {
                if (tasks_to_remove[names_of_wheels_to_generate[i]] === undefined) {
                    tasks_to_remove[names_of_wheels_to_generate[i]] = []
                }

                let title = document.createElement('h1')
                title.innerText = names_of_wheels_to_generate[i]
                title.style.display = 'inline-block'
                title.style.marginRight = '5px'
                title.style.marginBottom = '1vh'
                spins.appendChild(title)

                let count = document.createElement('p')
                count.style.display = 'inline'
                spins.appendChild(count)
                let x = 0
                for (let j = 0; j < wheels[names_of_wheels_to_generate[i]].length; j++) {
                    let text
                    let weight
                    let percentage
                    if (typeof wheels[names_of_wheels_to_generate[i]][j] === 'string') {
                        text = wheels[names_of_wheels_to_generate[i]][j]
                    } else {
                        if (wheels[names_of_wheels_to_generate[i]][j]['message'] !== undefined) {
                            text = wheels[names_of_wheels_to_generate[i]][j]['message']
                            if (wheels[names_of_wheels_to_generate[i]][j]['weight'] !== undefined) {
                                weight = wheels[names_of_wheels_to_generate[i]][j]['weight']
                            } else if (wheels[names_of_wheels_to_generate[i]][j]['percentage'] !== undefined) {
                                percentage = wheels[names_of_wheels_to_generate[i]][j]['percentage']
                            }
                        } else {
                            text = JSON.stringify(wheels[names_of_wheels_to_generate[i]][j])
                        }
                    }

                    if (filter !== '') {
                        if (!text.toUpperCase().includes(filter.toUpperCase())) {
                            continue;
                        }
                    }

                    let entry = document.createElement('div')
                    let dark = x % 2 === 0
                    if (dark) {
                        entry.style.background = 'darkgrey'
                    } else {
                        entry.style.background = 'lightgrey'
                    }
                    x++

                    entry.style.maxWidth = '1200px'
                    entry.style.verticalAlign = 'middle'
                    entry.style.alignItems = 'center'
                    entry.style.display = 'flex'
                    entry.style.height = 'auto'
                    spins.appendChild(entry)

                    let task = document.createElement('div')
                    task.style.fontSize = '16px'
                    task.style.marginRight = '30px'

                    if (filter !== '') {
                        text = text.replaceAll(new RegExp(escapeFilter(filter), 'gi'),
                            match => `<span style="background-color: yellow">${escapeReplacement(match)}</span>`)
                    }
                    let selected = tasks_to_remove[names_of_wheels_to_generate[i]].includes(j)
                    if (weight !== undefined || percentage !== undefined) {
                        let span_text = weight !== undefined ? `weight: ${weight}` : `odds: ${percentage}%`
                        text += `<br><span style="background-color: black; color: ${getEntryColor(false, dark)}">${span_text}</span>`
                    }
                    task.innerHTML = text

                    task.style.display = 'inline-block'
                    task.style.width = 'auto'
                    task.style.wordWrap = 'break-word'
                    task.style.whiteSpace = 'normal'
                    task.style.marginBottom = '10px'
                    task.style.marginTop = '10px'
                    task.style.marginLeft = '5px'
                    task.style.cursor = 'default'
                    task.className = 'noselect'
                    entry.appendChild(task)

                    entry.style.background = getEntryColor(selected, dark)
                    entry.addEventListener('click', function () {
                        if (!selected) {
                            tasks_to_remove[names_of_wheels_to_generate[i]].push(j)
                        } else {
                            removeItem(tasks_to_remove[names_of_wheels_to_generate[i]], j)
                        }
                        selected = !selected
                        entry.style.background = getEntryColor(selected, dark)
                    })
                }
                if (x === 0) {
                    title.remove()
                    count.remove()
                } else {
                    count.innerText = '(' + x + ')'
                }
            }

            let button = document.createElement('button')
            button.textContent = 'remove selected'
            button.style.marginLeft = '50px'
            button.style.marginTop = '20px'
            button.style.marginBottom = '200px'
            button.style.fontSize = '16px'
            button.style.cursor = 'pointer'
            button.className = 'button'
            spins.appendChild(button)
            button.addEventListener('click', function () {
                wheel_history.push([
                    JSON.parse(JSON.stringify(wheels)), 
                    JSON.parse(JSON.stringify(wheel_metadata)), 
                    JSON.parse(JSON.stringify(wheel_names))
                ])
                let desc = ''
                for (let i = 0; i < names_of_wheels_to_generate.length; i++) {
                    new_wheel = []
                    let num_removed = 0
                    for (let j = 0; j < wheels[names_of_wheels_to_generate[i]].length; j++) {
                        if (!tasks_to_remove[names_of_wheels_to_generate[i]].includes(j)) {
                            new_wheel.push(wheels[names_of_wheels_to_generate[i]][j])
                        } else {
                            num_removed += 1
                            if (isJson(wheels[names_of_wheels_to_generate[i]][j])) {
                                desc += 'removed: "' + JSON.stringify(wheels[names_of_wheels_to_generate[i]][j]) + '"\n'
                            } else {
                                desc += 'removed "' + wheels[names_of_wheels_to_generate[i]][j] + '"\n'
                            }
                        }
                    }
                    wheel_metadata[names_of_wheels_to_generate[i]].count -= num_removed
                    wheels[names_of_wheels_to_generate[i]] = new_wheel
                }
                wheel_history_descriptions.push(desc) 
                writeSheet(wheels_to_data(wheels, wheel_metadata, wheel_names), authToken)
                document.getElementById('spins-container').remove()
                tasks_to_remove = {}
                generate_entries(container, wheels, names_of_wheels_to_generate, authToken, filter)
            })
        }

        function getEntryColor(selected, dark) {
            if (selected) {
                if (dark) {
                    return '#F07971'
                } else {
                    return '#FAA0A0'
                }
            } else {
                if (dark) {
                    return 'darkgrey'
                } else {
                    return 'lightgrey'
                }
            }
        }

        function removeItem(arr, value) {
            var index = arr.indexOf(value)
            if (index > -1) {
                arr.splice(index, 1)
            }
            return arr
        }

        function opt(name) {
            let opt = document.createElement('option')
            opt.value = name
            opt.innerText = name
            return opt
        }

        function rand() {
            let container = document.createElement('div')
            container.id = 'container'
            document.body.appendChild(container)
            document.getElementById('wheel-dropdown').style.display = 'none'

            let rand_dropdown = document.createElement('select')
            rand_dropdown.style.marginTop = '15px'
            rand_dropdown.style.marginLeft = '10px'
            rand_dropdown.style.fontSize = '16px'
            rand_dropdown.id = 'rand-dropdown'
            rand_dropdown.appendChild(opt('random-number'))
            rand_dropdown.appendChild(opt('random-ordering'))
            rand_dropdown.appendChild(opt('coin-flip'))
            container.appendChild(rand_dropdown)
            rand_dropdown.value = random_dropdown_state
            rand_dropdown.addEventListener('change', function() {
                random_dropdown_state = rand_dropdown.value
            })


            let numinput = document.createElement('input')
            numinput.type = 'number'
            numinput.value = '3'
            numinput.style.marginTop = '15px'
            numinput.style.marginLeft = '10px'
            numinput.style.fontSize = '16px'
            numinput.style.width = '75px'
            numinput.addEventListener('keyup', function () {
                numinput.value = numinput.value.replace(/[^0-9]/g, '');
            })
            container.appendChild(numinput)

            let button = document.createElement('button')
            button.textContent = 'go!'
            button.style.marginLeft = '10px'
            button.style.marginTop = '20px'
            button.style.fontSize = '16px'
            button.style.cursor = 'pointer'
            button.className = 'button'
            container.appendChild(button)

            let output = document.createElement('div')
            button.addEventListener('click', function () {
                if (rand_dropdown.value === 'coin-flip') {
                    alert(Math.random() < 0.5 ? 'Heads' : 'Tails')
                }
                if (rand_dropdown.value === 'random-ordering') {
                    alert(getRandomOrdering(parseInt(numinput.value)))
                }
                if (rand_dropdown.value === 'random-number') {
                    alert(getRandomNumber(1, parseInt(numinput.value)))
                }
            })
        }

        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min
        }

        function getRandomOrdering(n) {
            // Create an array of numbers from 1 to n
            let arr = Array.from({ length: n }, (_, i) => i + 1);

            // Shuffle the array using the Fisher-Yates algorithm
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]]; // Swap elements
            }

            return arr;
        }

        // alert on all errors
        window.addEventListener('error', (e) => alert(e.message))
        start()
    </script>
</body>

</html>